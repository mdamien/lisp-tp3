\documentclass[a4paper, 10pt, leqno]{report}

\usepackage[T1]{fontenc}
\usepackage[french]{babel}
\usepackage[latin1]{inputenc}
\usepackage[babel=true]{csquotes}
\usepackage[top=1.5cm, bottom=2.0cm, left=2.0cm, right=2.0cm]{geometry}
\usepackage{fancyhdr}
\usepackage{graphicx}
\usepackage{amsmath}
\usepackage{soul}
\usepackage{amssymb}
\pagestyle{plain}
\usepackage{amsfonts}
\usepackage{amssymb}
\usepackage{amsthm}
\usepackage{graphicx}
\usepackage{color}
\usepackage{enumerate}
\usepackage{array}
\theoremstyle{plain}
\usepackage{blkarray}
\usepackage{listings}
\usepackage{algorithmicx}
\usepackage{algpseudocode}
\usepackage{algorithm}

\usepackage{caption}
\DeclareCaptionFont{white}{\color{white}}
\DeclareCaptionFormat{listing}{\colorbox{black}{\parbox{\textwidth}{#1#2#3}}}
\captionsetup[lstlisting]{format=listing,labelfont=white,textfont=white}

\lstset{
  basicstyle=\ttfamily\tiny
}

\title{\textsc{\textbf{Rapport TP n°3 IA01 \\ Diagnostic de panne de service web}}}
\author{\textbf{Damien MARI\'E et Antoine POUILLAUDE}}

\begin{document}
    \maketitle
    \tableofcontents

\chapter*{Introduction}

Pour ce TP, nous avons décidé d'implémenter un système expert capable de trouver la cause et la solution à une panne d'un service web. Cela permet d'être dans un domaine dont les système experts se sont déjà avérés très utiles. Le sujet étant vaste et complexe, seul une petite partie à été formalisée dans la base de règle.

Les connaisances exprimées ici se basent donc sur notre éxpérience en tant qu'administrateur de site internet et se déstine à d'autres administrateurs, plus débutant.

Afin de développer ce système expert d'ordre 0+, il nous faut pour cela une formalisation de la base de faits, de la base de règles et de la méthode d'inférence utilisée pour le parcours en largeur comme en profondeur.

\chapter{Formalisation}

\section{Base de règles}

Chaque règle est représentée par: Un identifiant, des prémisses et des actions.

\begin{lstlisting}
( id
	( ( premisse1) (premisse2) ...)
	( ( action1) (action2) ...)
)
\end{lstlisting}

Chaque prémisse étant constitué d'un opérateur de comparaison et de deux valeurs:

\begin{lstlisting}
( operateur valeur1 valeur2 valeur3 ...)
\end{lstlisting}

Exemple d'opérateur: =, <, >

De même les actions sont définis par un opérateur et des valeurs:
\begin{lstlisting}
( operateur valeur1 valeur2 valeur3 ...)
\end{lstlisting}

Exemple d'opérateur: set, print-message, ask

 \section{Base de faits}

De façon beaucoup plus simple, chaque fait est représenté par

\begin{lstlisting}
(idfait question)
\end{lstlisting}

\chapter{Implémentation}

\section{Base de faits}

\begin{lstlisting}[language=lisp]
(
(ERREUR_NAVIGATEUR "Quelle erreur est présente dans la navigateur ?")
(CHANGE_RECENT "Avez-vous récemment changer de DNS ?")
(HEURES_DEPUIS_CHANGEMENT "De combien de temps date ce changement ?")
(RENOUVELLEMENT_DNS "Avez-vous renouveler votre domaine ?")
(ACCES_PAR_IP_POSSIBLE "Si vous avez l'IP du service, pouvez-vous y acceder par adresse IP?")
(SITE_COURANTS_ACCESSIBLES "Pouvez-vous accéder à vos sites courants tel que google.fr, apple.fr ou viedemerde.com ?")
(PB_HEBERGEUR "Votre hebergeur à t-il reporté des problémes sur son infrastructure ?")
(SERVEUR_APP "Quel serveur d'application utilisez vous ? Apache, NGinx, ...")
)
\end{lstlisting}

\section{Base de régles}

\begin{lstlisting}[language=lisp]
(create_rule '((= ERREUR_NAVIGATEUR ERREUR_DNS)) '((set PROBLEME_DNS "True")))
(create_rule '((equal PROBLEME_DNS "True") (equal CHANGE_RECENT "True") (< HEURES_DEPUIS_CHANGEMENT 6)) '((solution "Probléme de propagation DNS")))
(create_rule '((equal RENOUVELLEMENT_DNS "False")) '((solution "Probléme de renouvellement DNS")))
(create_rule '((equal ACCES_PAR_IP_POSSIBLE "True")) '((solution "Autre probléme DNS")))
(create_rule '((equal SITE_COURANTS_ACCESSIBLES "False")) '((ask-question RENOUVELLEMENT_DNS "Avez-vous renouveler votre domaine ?")))
(create_rule '((= DNS_FAILED 650)) '((solution "Probléme hebergeur")))
(create_rule '((= ERREUR_NAVIGATEUR 502) (= SERVEUR_APP NGINX)) '((solution "Probléme de configuration NGINX")))
(create_rule '((= ERREUR_NAVIGATEUR 500)) '((solution "Probléme applicatif")))
\end{lstlisting}

\section{Moteur d'inférence}

\subsection{Parcours en profondeur}

\begin{lstlisting}[language=lisp]
(defun DFS_engine (facts rules &optional applied)
	(let ((applicable_rules (search_candidates facts rules applied)) (back_facts facts))
		(if (null applicable_rules) (setq applicable_rules (take_first *rules* applied)))
		(when (not (null applicable_rules))
			(dolist (rule_item applicable_rules)
				(setq facts back_facts)
				(dolist (action_item (get_actions rule_item))
					(print action_item)
					(if (execute_action action_item facts) T (return-from DFS_engine *solutions*))
				)
				(push rule_item applied)
				(DFS_engine facts rules applied)
			)
		)
	)
)
\end{lstlisting}

\section{Fonctions de service}

\begin{lstlisting}[language=lisp]
;;Algorithme de recherche de règles candidates
(defun search_candidates (facts rules applied &optional out)
(cond
((null rules) (return-from search_candidates out))
(t
	(let ((flag T)(studied_rule (car rules)))
		(when (not (member studied_rule applied))
			(let ((premises_studied_rule (get_premises studied_rule)))
				(dolist (premise premises_studied_rule)
					(when (not (verify_prem facts premises_studied_rule))
						(setq flag NIL)
						(return)
					)
				)
				(if flag (setq out (nconc out (list studied_rule))))
			)
		)
	)
	(search_candidates facts (cdr rules) applied out)
)
)
)
\end{lstlisting}

\begin{lstlisting}[language=lisp]
;;Algorithme de la fonction de vérification de premises
(defun verify_prem (facts premises)
(dolist (premise premises)
(cond 
	((null facts) NIL)
	((equal (car premise) 'is-known) (if (get_fact_value (in_fact? (cadr premise) facts) facts) T (return-from verify_prem NIL)))
	((equal (car premise) 'is-unknown) (if (get_fact_value (in_fact? (cadr premise) facts) facts) (return-from verify_prem NIL) T))
	(t  
		(let ((val_fact_1 (get_fact_value (in_fact? (cadr premise) facts) facts)) (val_fact_2))
		(if val_fact_1 
			(if (and (not (stringp (caddr premise))) (not (numberp (caddr premise)))) 
				(progn
					(setq val_fact_2 (get_fact_value (in_fact? (cadr premise) facts) facts))
					(if val_fact_2
						(if (apply (car premise) (list val_fact_1 val_fact_2)) T (return-from verify_prem NIL))
						(return-from verify_prem NIL)
					)
				)
				(if (apply (car premise) (list val_fact_1 (caddr premise))) T (return-from verify_prem NIL))
			)
			(return-from verify_prem NIL)
		)	
		)
	)
)
)
T	
)
\end{lstlisting}

\begin{lstlisting}[language=lisp]
;;Fonction qui pose une question
(defun ask_question (fact bfacts question)
	(print question)
	(let ((answer (read))(id_fact (in_fact? fact bfacts)))
		;La ligne du dessous sert à mettre en string si nécessaire
		(if (not (numberp answer)) (setq answer (string answer)))
		(cond
		 	(id_fact 
				(setf (cadr (get_fact id_fact bfacts)) T)
				(setf (caddr (get_fact id_fact bfacts)) answer)
				(symbol-value id_fact)
			)
			(t 
				(create_fact fact t answer)
			)		
		)
	)
)
\end{lstlisting}

\begin{lstlisting}[language=lisp]
;;Fonction qui cherche un fait dans la base de faits
(defun in_fact? (fact bfacts)
	(cond
		((null bfacts) NIL)
		((equal (car (symbol-value (car bfacts))) fact) (car bfacts))
		(t (in_fact? fact (cdr bfacts)))
	)
)
\end{lstlisting}


\begin{lstlisting}[language=lisp]
;;Fonction qui crée un fait
(defun create_fact (fact &optional known? value)
	(let ((id_fact (gentemp "F")))
		(set id_fact (list fact known? value))
		(setq *facts* (nconc *facts* (list id_fact)))
		id_fact
	)
)
\end{lstlisting}

\begin{lstlisting}[language=lisp]
;;Fonction qui crée les règles
(defun create_rule (premise induction)
	(let ((id_rule (gentemp "R")))
		(set id_rule (list id_rule premise induction))
		(setq *rules* (nconc *rules* (list id_rule)))
		id_rule
	)
)
\end{lstlisting}

\begin{lstlisting}[language=lisp]
;;Algorithme d'execution des actions induites par l'application des règles
(defun execute_action (action facts)
(case (car action)
(solution (print (cadr action)) (setq *solutions* (nconc *solutions* (list (cadr action))))
	(print "Souhaitez-vous chercher d'autres solutions ? Y/N")
	(setq answer (read))
	(if (or (equal answer 'y) (equal answer 'Y)) T (return-from execute_action NIL))
)
(set 
	(let ((id_fact (in_fact? (cadr action) facts)))
		(if id_fact (set_value id_fact (caddr action)) (create_fact facts (cadr action) T (caddr action)))
	)
	T	
)
(ask-question 
	(ask_question (cadr action) facts (caddr action))
	T
)
)
T
)
\end{lstlisting}

\section{Exemple de fonctionnement}

Probléme DNS
\begin{lstlisting}
Connexion au site possible ? NON
Affiche une erreur ? OUI
Quel type d'erreur ? Erreur DNS
Pouvez-vous accéder à des sites courants tel que google.fr ou apple.com ? OUI
Avez-vous changer les enregistrements DNS récemment ? OUI
Il y a combien de temps ? 1h
Celà semble être un probléme d'enregistrement DNS. Celà prend a plupart du temps plus de 4h à ce répandre sur le réseau.
Souhaitez-vous chercher d'autres solutions ? N
\end{lstlisting}

Probléme réseau utilisateur
\begin{lstlisting}
Connexion au site possible ? NON
Affiche une erreur ? OUI
Pouvez-vous accéder à des sites courants tel que google.fr ou apple.com ? NON
Le probléme semble être dans votre connexion.
Souhaitez-vous chercher d'autres solutions ? N
\end{lstlisting}

Probléme de configuration proxy NGINX
\begin{lstlisting}
Connexion au site possible ? OUI
Affiche une erreur (site) ? OUI
Quel type d'erreur (site) ? 502
Est-ce que votre site utilise NGINX ? OUI
Il y a plusieurs solutions possibles:
* Nginx est en proxy avec Apache et Apache et injoignable (ou un autre serveur web)
* Configuration du buffer et du timeout insuffisante, essayez ces réglages
Est-ce que le serveur web derriére NGINX est bien démarré et fonctionnel (verifier les logs) ? OUI
Souhaitez-vous chercher d'autres solutions ? N
\end{lstlisting}

\chapter*{Conclusion}

En conclusion, la partie la plus difficile de ce TP fut de choisir un sujet applicable aux systéme expert et dont nous avions assez de connaissances pour pouvoir en tirer des informations cohérentes. 

\end{document}
